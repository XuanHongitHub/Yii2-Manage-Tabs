$(document).ready(function () {
    $(document).off('click', '#edit-richtext').on('click', '#edit-richtext', function () {
        var pageId = $(this).data('id');
        var baseUrl = window.location.origin + '/admin/';
        window.location.href = baseUrl + 'pages/edit?id=' + pageId;
    });


    $(document).off('click', '.edit-btn').on('click', '.edit-btn', function () {
        var pageId = $(this).data('page-id');
        var pageName = $(this).data('page-name');
        var status = $(this).data('page-status');
        console.log("üöÄ ~ status:", status);

        $('#editName').val(pageName);
        $('#editStatus').val(status);
        $('#editPageForm').data('page-id', pageId);
        $('#editModal').modal('show');
    });
    $(document).off('click', '#savePageChanges').on('click', '#savePageChanges', function () {
        var form = $('#editPageForm');
        var pageId = form.data('page-id');
        var pageName = $('#editName').val();
        var status = $('#editStatus').val();
        var isValid = true;

        $('#editNameError').hide();

        if (!pageName) {
            $('#editNameError').text('T√™n page kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.').show();
            isValid = false;
        } else if (/[^a-zA-Z√Ä-·ªπ√†-·ªπ0-9_ ]/g.test(pageName)) {
            $('#editNameError').text('T√™n page kh√¥ng ch·ª©a k√Ω t·ª± ƒë·∫∑c bi·ªát.').show();
            isValid = false;
        } else if (pageName.length > 30) {
            $('#editNameError').text('T√™n page kh√¥ng ƒë∆∞·ª£c qu√° 30 k√Ω t·ª±.').show();
            isValid = false;
        }

        if (isValid) {
            $.ajax({
                url: update_page_url,
                type: 'POST',
                headers: {
                    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
                },
                data: {
                    pageId,
                    status,
                    pageName,
                },
                success: function (response) {
                    $('#editModal').modal('hide');
                    location.reload();
                },
                error: function () {
                    alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.');
                }
            });
        }
    });

    $(document).off('click', '.setting-btn').on('click', '.setting-btn', function () {
        var pageId = $(this).data('page-id');
        var button = $(this);
        button.prop('disabled', true);

        $.ajax({
            url: get_table_page_url,
            method: 'GET',
            data: { pageId: pageId },
            success: function (response) {
                var columns = response.columns;
                var hiddenColumns = response.hiddenColumns;

                var columnsList = $('#columns-visibility tbody tr td .list-group');
                columnsList.empty();

                columns.forEach(function (column) {
                    var isChecked = hiddenColumns[column] === undefined || hiddenColumns[column] ? 'checked' : '';

                    var columnRow = `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${column}</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input column-switch"
                                    type="checkbox"
                                    id="switch-${column}"
                                    data-column="${column}" ${isChecked}>
                            </div>
                        </div>
                    `;
                    columnsList.append(columnRow);
                });

                $('#save-columns-visible').data('page-id', pageId);

                $('#settingModal').modal('show');
            },
            error: function () {
                alert('L·ªói khi t·∫£i d·ªØ li·ªáu c·ªôt');
            },
            complete: function () {
                button.prop('disabled', false);
            }
        });
    });

    $(document).off('click', '#save-columns-visible').on('click', '#save-columns-visible', function () {
        var pageId = $(this).data('page-id');
        if (!pageId) {
            alert('Page ID kh√¥ng h·ª£p l·ªá.');
            return;
        }

        let columnsVisibility = [];

        $('#columns-visibility .column-switch').each(function (index) {
            const columnName = $(this).data('column');
            const isChecked = $(this).prop('checked');

            columnsVisibility.push({
                column_name: columnName,
                is_visible: isChecked
            });
        });

        $.ajax({
            url: save_column_visibility_url,
            type: 'POST',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            data: {
                pageId: pageId,
                columns_visibility: columnsVisibility
            },
            success: function (response) {
                if (response.success) {
                    showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng');
                    $('#settingModal').modal('hide');
                } else {
                    showToast('L·ªói c·∫≠p nh·∫≠t: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                showToast('L·ªói AJAX: ' + error);
            }
        });
    });


    $('#confirm-hide-btn').click(function () {
        let hideStatus = {};

        $('.toggle-hide-btn').each(function () {
            const pageId = $(this).data('page-id');
            const isChecked = $(this).is(':checked');
            hideStatus[pageId] = isChecked ? 0 : 1;
        });

        if (confirm("X√°c nh·∫≠n thao t√°c?")) {

            $.ajax({
                url: update_status_url,
                method: 'POST',
                headers: {
                    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
                },
                data: {
                    hideStatus: hideStatus
                },
                success: function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message || "C√≥ l·ªói x·∫£y ra khi l∆∞u thay ƒë·ªïi.");
                    }
                },
                error: function () {
                    alert("C√≥ l·ªói x·∫£y ra khi l∆∞u thay ƒë·ªïi.");
                }
            });
        }
    });
    $('#toggleStatusPages').on('change', function () {
        const showAll = $(this).is(':checked');

        $('.page-item').each(function () {
            const isStatus = $(this).data('status') == 1;
            if (isStatus) {
                $(this).toggleClass('hidden-page', !showAll);
            }
        });
    });

    $(document).on('click', '.restore-page-btn', function () {
        const pageId = $(this).data('page-id');

        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c page n√†y kh√¥ng?")) {
            $.ajax({
                url: restore_page_url,
                method: 'POST',
                headers: {
                    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
                },
                data: {
                    pageId: pageId,
                },
                success: function (response) {
                    if (response.success) {
                        location.reload();
                        $('#trashBinModal').modal('hide');
                    } else {
                        alert(response.message || "Kh√¥i ph·ª•c th·∫•t b·∫°i.");
                    }
                },
                error: function () {
                    alert("C√≥ l·ªói x·∫£y ra khi kh√¥i ph·ª•c.");
                }
            });
        }
    });

    $(document).on('click', '.delete-page-btn', function () {
        const pageId = $(this).data('page-id');

        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ho√†n to√†n page n√†y kh√¥ng?")) {
            $.ajax({
                url: delete_permanently_url,
                method: 'POST',
                headers: {
                    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
                },
                data: {
                    pageId: pageId,
                },
                success: function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message || "X√≥a th·∫•t b·∫°i.");
                    }
                },
                error: function () {
                    alert("C√≥ l·ªói x·∫£y ra khi x√≥a page.");
                }
            });
        }
    });

    $(document).off('click', '#confirm-delete-btn').on('click', '#confirm-delete-btn', function () {
        const pageId = $(this).data('page-id');

        $.ajax({
            url: delete_soft_url,
            method: 'POST',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            data: {
                pageId: pageId,
            },
            success: function (response) {
                if (response.success) {
                    location.reload();
                    $('#deleteModal').modal('hide');
                } else {
                    alert(response.message || "X√≥a page th·∫•t b·∫°i.");
                }
            },
            error: function () {
                alert("C√≥ l·ªói x·∫£y ra khi x√≥a page.");
            }
        });
    });
    $(document).off('click', '#confirm-delete-permanently-btn').on('click', '#confirm-delete-permanently-btn', function () {
        const pageId = $(this).data('page-id');

        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ho√†n to√†n kh√¥ng?")) {
            $.ajax({
                url: delete_permanently_url,
                method: 'POST',
                headers: {
                    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
                },
                data: {
                    pageId: pageId,
                },
                success: function (response) {
                    if (response.success) {
                        location.reload();
                        $('#deleteModal').modal('hide');
                    } else {
                        alert(response.message || "X√≥a page th·∫•t b·∫°i.");
                    }
                },
                error: function () {
                    alert("C√≥ l·ªói x·∫£y ra khi x√≥a page.");
                }
            });
        }
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const deleteButtons = document.querySelectorAll(".delete-btn");
    const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
    const confirmDeletePermanentlyBtn = document.getElementById("confirm-delete-permanently-btn");

    deleteButtons.forEach(button => {
        button.addEventListener("click", function () {
            const pageId = this.getAttribute("data-page-id");
            confirmDeleteBtn.setAttribute("data-page-id", pageId);
            confirmDeletePermanentlyBtn.setAttribute("data-page-id", pageId);
        });
    });
});